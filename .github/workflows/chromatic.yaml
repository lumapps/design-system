name: Chromatic

on:
  pull_request:
    types: [ opened, synchronize, reopened, labeled ]
  push:
    tags:
        - v*

jobs:
  deploy:
    # Run on push version tag OR on PR with the "need: review-design" label
    if: "github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'need: review-design')"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout repository"
        uses: actions/checkout@5a4ac9002d0be2fb38bd78e4b4dbde5606d7042f #v2.3.4
        with:
          fetch-depth: 0 # Required to retrieve git history

      - name: "Setup node env"
        uses: actions/setup-node@c6fd00ceb9747fb23ffdf72987450a2664414867 #v2.1.2
        with:
            node-version: '13.7.0'

      - name: "Get yarn cache directory path"
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"

      - name: "Dependency cache"
        uses: actions/cache@26968a09c0ea4f3e233fdddbafd1166051a095f6 #v2.1.4
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: "Install dependencies"
        run: yarn install --frozen-lockfile --ignore-optional

      - name: "Deploy chromatic"
        uses: chromaui/action@e649c933d14575142ba0c25a806807752c60dad5 #v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          projectToken: ${{ secrets.CHROMATIC_TOKEN }}
          buildScriptName: build:storybook
